# EMS (嵌入式音乐谱) 格式规范 v1.0

[English Version](format.md) | 中文版本

## 概述

EMS (嵌入式音乐谱) 是一种专为嵌入式系统和单音乐器设计的轻量级音乐记谱格式。它使用简单的基于字符串的语法，具有人类可读、内存高效且易于在微控制器上解析的特点。

## 语法结构

```ems
(BPM){默认节拍}音符序列
```

### 组成部分

1. **BPM部分** (可选): `(120)` - 每分钟节拍数，用圆括号包围
2. **默认节拍** (可选): `{4}` - 默认音符时长，用花括号包围
3. **音符序列**: 带有可选修饰符的音符系列

## 基本音符

EMS使用数字音乐记谱法 (简谱/数字记谱法):

1 = Do (C) 
2 = Re (D) 
3 = Mi (E) 
4 = Fa (F) 
5 = Sol (G) 
6 = La (A) 
7 = Si (B) 
0 = 休止符/静音

## 时长修饰符

时长修饰符放在音符数字**之后**:

- `1,` = 一拍 (默认时长)
- `1-` = 半拍 (1/2)
- `1.` = 四分之一拍 (1/4)
- `1_` = 两拍 (2x)

## 八度修饰符

八度修饰符使用反引号放在音符前后:

- `` `1`` = 降低一个八度
- `1`` = 升高一个八度

## 变音记号 (升号和降号)

使用字母表示半音变化:

- `1s` = 升号 (升高半音)
- `1b` = 降号 (降低半音)

### 有效的变音记号
- **升号**: 1s, 2s, 4s, 5s, 6s
- **降号**: 2b, 3b, 5b, 6b, 7b

注意: 3s=4, 4b=3, 7s=1`, 1b=7` (等音)

## 修饰符组合顺序

组合修饰符时，使用以下顺序:

```ems
[降八度][音符][变音记号][时长][升八度]
```

示例:

- `` `1s,`` = C# 降一个八度，一拍
- `` `2b-``1` = Db 半拍，然后C升一个八度
- `4s.` = F# 四分之一拍

## 完整格式结构

```ems
(BPM){默认节拍}音符[修饰符],音符[修饰符],...
```

### 默认值
- **BPM**: 如未指定则为120
- **默认节拍**: 如未指定则为4 (四分音符)
- **时长**: 如未指定则为一拍
- **八度**: 如未指定则为中音八度 (第4八度)

## 示例

### 基本音阶

```ems
(120){4}1,2,3,4,5,6,7,1`
```

*C大调音阶，120 BPM，四分音符*

### 带变音记号

```ems
(140){8}1,1s,2,2s,3,4,4s,5,5s,6,6s,7,1`
```

*半音阶，140 BPM，八分音符*

### 混合时长

```ems
(100){4}1,2-,3.,4,5_,6,7,1`
```

*混合节奏：四分音符，八分音符，十六分音符，四分音符，二分音符，四分音符，四分音符，四分音符*

### 八度变化

```ems
(120){4}`1,`2,`3,4,5,6,7,1`,2`,3`
```

*从低八度到高八度的音阶*

### 带休止符

```ems
(120){4}1,0,3,0,5,0,1`
```

*音符之间带休止符*

## 实现说明

### 解析指南
1. 首先解析BPM (如果存在)
2. 解析默认节拍 (如果存在)
3. 遍历音符序列
4. 对于每个音符，按顺序解析：降八度、音符、变音记号、时长、升八度
5. 计算最终频率和时长
6. 生成音符结构

### 内存考虑
- 在可能的情况下在编译时预计算音符数组
- 使用查找表进行频率计算
- 考虑为嵌入式系统使用整数运算

### 错误处理
- 无效音符数字 (不是0-7): 当作休止符处理
- 无效修饰符: 优雅地忽略
- 缺少BPM/节拍: 使用默认值
- 空字符串: 生成静音

## 文件扩展名
推荐文件扩展名: `.ems`

示例: `twinkle_star.ems`

---

*EMS 格式规范 v1.0*  
*作者: 月羽 & 织星*  
*日期: 2025-07-28*
